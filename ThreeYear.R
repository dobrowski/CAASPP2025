
### Confetti Groups ----


confetti.groups <- c(
    1	,	#	All Students	,	All Students	,
    128	,	#	Disability Status	,	Reported disabilities	,
    # 99	,	#	Disability Status	,	No reported disabilities	,
    31	,	#	Economic Status	,	Socioeconomically disadvantaged	,
    # 111	,	#	Economic Status	,	Not socioeconomically disadvantaged	,
    # 6	,	#	English-Language Fluency	,	IFEP, RFEP, and EO (Fluent English proficient and English only)	,
#    7	,	#	English-Language Fluency	,	IFEP (Initial fluent English proficient)	,

#    8	,	#	English-Language Fluency	,	RFEP (Reclassified fluent English proficient)	,
    # 120	,	#	English-Language Fluency	,	ELs enrolled less than 12 months	,
    # 142	,	#	English-Language Fluency	,	ELs enrolled 12 months or more	,
    160	,	#	English-Language Fluency	,	EL (English learner)	,
    # 243	,	#	English-Language Fluency	,	ADEL (Adult English learner)	,
#    180	,	#	English-Language Fluency	,	EO (English only)	,
    # 170	,	#	English-Language Fluency	,	Ever–EL	,
#    250	,	#	English-Language Fluency	,	LTEL (Long-Term English learner)	,
    # 251	,	#	English-Language Fluency	,	AR–LTEL (At-Risk of becoming LTEL)	,
    # 252	,	#	English-Language Fluency	,	Never–EL	,
    # 190	,	#	English-Language Fluency	,	TBD (To be determined)	,
    75	,	#	Race and Ethnicity	,	American Indian or Alaska Native	,
    76	,	#	Race and Ethnicity	,	Asian	,
    74	,	#	Race and Ethnicity	,	Black or African American	,
    77	,	#	Race and Ethnicity	,	Filipino	,
    78	,	#	Race and Ethnicity	,	Hispanic or Latino	,
    79	,	#	Race and Ethnicity	,	Native Hawaiian or Pacific Islander	,
    80	,	#	Race and Ethnicity	,	White	,
    144	,	#	Race and Ethnicity	,	Two or more races	,
    # 201	,	#	Ethnicity for Economically Disadvantaged	,	American Indian or Alaska Native	,
    # 202	,	#	Ethnicity for Economically Disadvantaged	,	Asian	,
    # 200	,	#	Ethnicity for Economically Disadvantaged	,	Black or African American	,
    # 203	,	#	Ethnicity for Economically Disadvantaged	,	Filipino	,
    # 204	,	#	Ethnicity for Economically Disadvantaged	,	Hispanic or Latino	,
    # 205	,	#	Ethnicity for Economically Disadvantaged	,	Native Hawaiian or Pacific Islander	,
    # 206	,	#	Ethnicity for Economically Disadvantaged	,	White	,
    # 207	,	#	Ethnicity for Economically Disadvantaged	,	Two or more races	,
    # 221	,	#	Ethnicity for Not Economically Disadvantaged	,	American Indian or Alaska Native	,
    # 222	,	#	Ethnicity for Not Economically Disadvantaged	,	Asian	,
    # 220	,	#	Ethnicity for Not Economically Disadvantaged	,	Black or African American	,
    # 223	,	#	Ethnicity for Not Economically Disadvantaged	,	Filipino	,
    # 224	,	#	Ethnicity for Not Economically Disadvantaged	,	Hispanic or Latino	,
    # 225	,	#	Ethnicity for Not Economically Disadvantaged	,	Native Hawaiian or Pacific Islander	,
    # 226	,	#	Ethnicity for Not Economically Disadvantaged	,	White	,
    # 227	,	#	Ethnicity for Not Economically Disadvantaged	,	Two or more races	,
#    4	,	#	Gender	,	Female	,
#    3	,	#	Gender	,	Male	,
#    28	,	#	Migrant	,	Migrant education	,
    # 29	,	#	Migrant	,	Not migrant education	,
    # 90	,	#	Parent Education	,	Not a high school graduate	,
    # 91	,	#	Parent Education	,	High school graduate	,
    # 92	,	#	Parent Education	,	Some college (includes AA degree)	,
    # 93	,	#	Parent Education	,	College graduate	,
    # 94	,	#	Parent Education	,	Graduate school/Postgraduate	,
    # 121	,	#	Parent Education	,	Declined to state	,
    # 50	,	#	Military Status	,	Armed forces family member	,
    # 51	,	#	Military Status	,	Not armed forces family member	,
    52	,	#	Homeless Status	,	Homeless	,
    # 53	,	#	Homeless Status	,	Not homeless	,
    240		#	Foster Status	,	Foster youth	,
    # 241		#	Foster Status	,	Not foster youth	,
)




confetti.nmcusd.groups <- c(
    1	,	#	All Students	,	All Students	,
    128	,	#	Disability Status	,	Reported disabilities	,
    # 99	,	#	Disability Status	,	No reported disabilities	,
    31	,	#	Economic Status	,	Socioeconomically disadvantaged	,
    # 111	,	#	Economic Status	,	Not socioeconomically disadvantaged	,
    # 6	,	#	English-Language Fluency	,	IFEP, RFEP, and EO (Fluent English proficient and English only)	,
    #    7	,	#	English-Language Fluency	,	IFEP (Initial fluent English proficient)	,
    
        8	,	#	English-Language Fluency	,	RFEP (Reclassified fluent English proficient)	,
     120	,	#	English-Language Fluency	,	ELs enrolled less than 12 months	,
    # 142	,	#	English-Language Fluency	,	ELs enrolled 12 months or more	,
    160	,	#	English-Language Fluency	,	EL (English learner)	,
    # 243	,	#	English-Language Fluency	,	ADEL (Adult English learner)	,
    #    180	,	#	English-Language Fluency	,	EO (English only)	,
    # 170	,	#	English-Language Fluency	,	Ever–EL	,
        250	,	#	English-Language Fluency	,	LTEL (Long-Term English learner)	,
    # 251	,	#	English-Language Fluency	,	AR–LTEL (At-Risk of becoming LTEL)	,
    # 252	,	#	English-Language Fluency	,	Never–EL	,
    # 190	,	#	English-Language Fluency	,	TBD (To be determined)	,
  #  75	,	#	Race and Ethnicity	,	American Indian or Alaska Native	,
   # 76	,	#	Race and Ethnicity	,	Asian	,
 #   74	,	#	Race and Ethnicity	,	Black or African American	,
 #   77	,	#	Race and Ethnicity	,	Filipino	,
    78	,	#	Race and Ethnicity	,	Hispanic or Latino	,
 #   79	,	#	Race and Ethnicity	,	Native Hawaiian or Pacific Islander	,
    80	,	#	Race and Ethnicity	,	White	,
  #  144	,	#	Race and Ethnicity	,	Two or more races	,
    # 201	,	#	Ethnicity for Economically Disadvantaged	,	American Indian or Alaska Native	,
    # 202	,	#	Ethnicity for Economically Disadvantaged	,	Asian	,
    # 200	,	#	Ethnicity for Economically Disadvantaged	,	Black or African American	,
    # 203	,	#	Ethnicity for Economically Disadvantaged	,	Filipino	,
    # 204	,	#	Ethnicity for Economically Disadvantaged	,	Hispanic or Latino	,
    # 205	,	#	Ethnicity for Economically Disadvantaged	,	Native Hawaiian or Pacific Islander	,
    # 206	,	#	Ethnicity for Economically Disadvantaged	,	White	,
    # 207	,	#	Ethnicity for Economically Disadvantaged	,	Two or more races	,
    # 221	,	#	Ethnicity for Not Economically Disadvantaged	,	American Indian or Alaska Native	,
    # 222	,	#	Ethnicity for Not Economically Disadvantaged	,	Asian	,
    # 220	,	#	Ethnicity for Not Economically Disadvantaged	,	Black or African American	,
    # 223	,	#	Ethnicity for Not Economically Disadvantaged	,	Filipino	,
    # 224	,	#	Ethnicity for Not Economically Disadvantaged	,	Hispanic or Latino	,
    # 225	,	#	Ethnicity for Not Economically Disadvantaged	,	Native Hawaiian or Pacific Islander	,
    # 226	,	#	Ethnicity for Not Economically Disadvantaged	,	White	,
    # 227	,	#	Ethnicity for Not Economically Disadvantaged	,	Two or more races	,
    #    4	,	#	Gender	,	Female	,
    #    3	,	#	Gender	,	Male	,
    #    28	,	#	Migrant	,	Migrant education	,
    # 29	,	#	Migrant	,	Not migrant education	,
    # 90	,	#	Parent Education	,	Not a high school graduate	,
    # 91	,	#	Parent Education	,	High school graduate	,
    # 92	,	#	Parent Education	,	Some college (includes AA degree)	,
    # 93	,	#	Parent Education	,	College graduate	,
    # 94	,	#	Parent Education	,	Graduate school/Postgraduate	,
    # 121	,	#	Parent Education	,	Declined to state	,
    # 50	,	#	Military Status	,	Armed forces family member	,
    # 51	,	#	Military Status	,	Not armed forces family member	,
    52		#	Homeless Status	,	Homeless	,
    # 53	,	#	Homeless Status	,	Not homeless	,
 #   240		#	Foster Status	,	Foster youth	,
    # 241		#	Foster Status	,	Not foster youth	,
)








# Three Comparisons for Charter Schools 
colors_vec <- c( "#E41A1C", "#79577C", "#3C899E", "#49A75A", "#6F8273",  "#9F5196",
                "#DF6F32",  "#FFA60F", "#FFF52F",  "#CFA42D",  "#B25C3F" , "#E4779C",
                "#D28AB0" , "#999999"
)



confetti_vec <- c(
    "All Students"                       = "#E41A1C", 
    "Economically disadvantaged"         = "#3C899E",
    "Homeless"                            = "#79577C", 
    "Black or African American"           =  "#CFA42D",
    "American Indian or Alaska Native"   = "#6F8273",
    "Asian"                               =  "#DF6F32",
    "Filipino"                            =  "#9F5196",
    "Hispanic or Latino"                  = "#E4779C",
    "Native Hawaiian or Pacific Islander" =  "#B25C3F" ,
    "White"                               =  "#FFA60F",
    "Students with disability"            = "#FFF52F",
    "Two or more races"                  = "#D28AB0" ,
    "English learner"                     =  "#49A75A",
    "Foster Youth"    = "#999999"
)






three.years <- function(df, 
                        collie, 
                        color_collie,
                        test.id = 1, 
                        title.name#, 
                   #      kular = "Steel Blue"
                        ) {
    
    test.name <-  case_match(test.id, 1 ~ "ELA",
                             2 ~ "Math",
                             17 ~ "Science",
    )
    
    df <- df %>%
        filter(test_id == test.id) 
    #   mutate(coll = fct_reorder({{collie}}, desc(Percentage_Standard_Met_and_Above))) %>%
    
    
    
    ggplot(df, mapping = aes(x = test_year,
                         y = percentage_standard_met_and_above/100,
                         label = round(percentage_standard_met_and_above,1),
                         group = {{collie}},
                         colour = {{color_collie}})) +
       
        geom_line(size = 3) +
        geom_point(size = 5) +
        expand_limits(y = 0) +
        geom_text(color = "black",
                  vjust = -1,
                  size = 3) +
        geom_blank( aes(x=test_year, y=percentage_standard_met_and_above*1.2/100, label=percentage_standard_met_and_above)) +
        scale_color_manual(values = confetti_vec) +
        mcoe_theme +
  #      scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
         facet_wrap(as.formula(paste0( "~", collie ) ) ) +
        
        theme(panel.border = element_rect(fill=NA,color="darkgrey", size=0.5,
                                          linetype="solid"),
              strip.background = element_rect(color="black", size=0.5, linetype="solid"  )

        )+  # Adds a border around each panel
        theme(legend.position = "none") +
        scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
        labs(title = paste0(title.name, " CAASPP ", test.name ," Meeting or Exceeding Standard"),
             subtitle = paste0("Three Year Trend (2022-24)"),
             y = "",
             x = "",
             caption = source.link
        ) 
    
     ggsave(here("figs", "confetti", paste0(title.name, " ", test.name,  " Three Year Percentage ",  Sys.Date(),".png" )),
            width = 12, height = 7)
    
}



cast.mry  %>%
    filter(str_detect(entity_type, "harter"),
           subgroup_id == 1,
           grade == 13) %>%
    three.years(collie = school_name,
                test.id =  17, 
                title.name =  "Charter Schools ")




caaspp.mry.hist <- tbl(con, "CAASPP") %>% 
    filter(county_code == "27",
           # DistrictCode == "10272",
           test_year >= 2022) %>%
    collect() %>%
    mutate(subgroup_id = as.character(subgroup_id)) %>%
    left_join_codebook("CAASPP", "subgroup_id") %>%
    rename(subgroup = definition) %>%
    left_join(ent2, by = join_by(county_code, district_code, school_code)) %>%
    mutate(type_id = as.character(type_id)) %>%
    left_join_codebook("CAASPP", "type_id") %>%
    rename(entity_type = definition) %>%
    mutate(across(caaspp_reported_enrollment:area_4_percentage_near_standard, as.numeric)) %>%
    mutate(district_name = coalesce(district_name.x,district_name.y ),
           school_name = coalesce(school_name.x,school_name.y ) 
    ) 

caaspp.imp.hist <- read_rds("caaspp.rds")


caaspp.mry.hist  %>%
    filter(str_detect(entity_type, "harter"),
           subgroup_id == 1,
           grade == 13) %>%
    three.years(collie = school_name,
                test.id = 1, 
                title.name =  "Charter Schools ")


# Soledad ELA 


caaspp.mry.hist  %>%
    filter(str_detect(school_name, "Main Street"),
           subgroup_id %in% confetti.groups,
           grade == 13,
           !is.na(percentage_standard_met_and_above)
    ) %>%
    three.years(collie = "subgroup",
                color_collie = subgroup,
                test.id = 1, 
                title.name =  "Main Street ")














### Math COP ----

caaspp.mry.hist  %>%
    mutate(test_year = factor(test_year)) %>%
    filter(grade == 13,
          subgroup_id %in% confetti.groups,
           test_id == 2, # ELA 
           entity_type == "County"
           ) %>%
    three.years(collie = "subgroup",
                color_collie = subgroup,
                test.id = 2, 
                title.name =  "Monterey County ")




caaspp.imp.hist2 <- caaspp.imp.hist  %>%
    mutate(subgroup_id = as.character(subgroup_id)) %>%
    left_join_codebook("CAASPP", "subgroup_id") %>%
    rename(subgroup = definition) %>%
    left_join(ent2) %>%
    mutate(type_id = as.character(type_id)) %>%
    left_join_codebook("CAASPP", "type_id") %>%
    rename(entity_type = definition) 

caaspp.imp.hist3 <- caaspp.imp.hist2 %>%
    mutate(subgroup_id = coalesce(as.character( subgroup_id), as.character( student_group_id) )) %>%
    filter( test_year %in% c(2022, 2023, 2024),
         grade == 13,
            subgroup_id %in% confetti.groups,
            test_id == 2, # ELA 
      #  district_code == 00000
           entity_type == "County"
    ) %>%
    left_join_codebook("CAASPP", "subgroup_id") %>%
    rename(subgroup2 = definition) %>%
    select(-subgroup) %>%
    rename(subgroup = subgroup2) %>%
    
     mutate(test_year = factor(test_year),
            percentage_standard_met_and_above = as.numeric(percentage_standard_met_and_above))
     
caaspp.imp.hist3 %>%
    three.years(collie = "subgroup",
                color_collie = subgroup,
                test.id = 2, 
                title.name =  "Anonymous County ")







three.years.math.fuller <- function(df, namer, ent.level, testy = 2) {
    
holder <-     df  %>%
    mutate(test_year = factor(test_year)) %>%
        filter(grade == 13,
               subgroup_id %in% confetti.groups,
               test_id == testy, # ELA 
               entity_type == ent.level,
               !is.na(percentage_standard_met_and_above)
        ) 
        

if( ent.level == "School" ) {
    holder <- holder %>%
        filter(str_detect(school_name, namer))
} else {
    holder <- holder %>%
        filter(str_detect(district_name, namer))
}


holder %>%
        three.years(collie = "subgroup",
                    color_collie = subgroup,
                    test.id = testy, 
                    title.name =  namer)

}


three.years.math.fuller(caaspp.mry.hist, "North Monterey County", "District")
three.years.math.fuller(caaspp.mry.hist, "North Monterey County Middle", "School")
three.years.math.fuller(caaspp.mry.hist, "North Monterey County High", "School")
three.years.math.fuller(caaspp.mry.hist, "Salinas City", "District")
three.years.math.fuller(caaspp.mry.hist, "Loma Vista", "School")
three.years.math.fuller(caaspp.mry.hist, "Lincoln", "School")
three.years.math.fuller(caaspp.mry.hist, "Boronda Meadows", "School")
three.years.math.fuller(caaspp.mry.hist, "Soledad", "District")
three.years.math.fuller(caaspp.mry.hist %>% filter(str_detect(district_name,"Soledad")), "Gabilan", "School")
three.years.math.fuller(caaspp.mry.hist, "Soledad High", "School")
three.years.math.fuller(caaspp.mry.hist, "Franscioni", "School")
three.years.math.fuller(caaspp.mry.hist, "South Monterey County", "District")
three.years.math.fuller(caaspp.mry.hist, "King City High", "School")
three.years.math.fuller(caaspp.mry.hist, "Greenfield High", "School")
three.years.math.fuller(caaspp.mry.hist, "Pinnacle Coastal Valley High", "School")
three.years.math.fuller(caaspp.mry.hist, "Gonzales", "District")
three.years.math.fuller(caaspp.mry.hist, "Fairview", "School")
three.years.math.fuller(caaspp.mry.hist, "Gonzales High", "School")


three.years.math.fuller(caaspp.mry.hist, "Robert Down", "School", 1)
three.years.math.fuller(caaspp.mry.hist, "Robert Down", "School", 2)


caaspp.mry.hist %>%
    filter(str_detect(district_name, "Greenfield")) %>%
    distinct(school_name)

school.list <- c(
"Soledad",
"Gonzales"
)

for (i in school.list) {
    for (j in 1:2) {
        three.years.math.fuller(caaspp.mry.hist, i, "District", j)
    }
}




temp <- caaspp.mry.hist %>%
    filter(entity_type == "District") %>%
#    filter(str_detect(district_name, "Greenfield")) %>%
    distinct(district_name) %>%
    na.omit()

school.list <- temp$district_name



### NMCUSD -------


caaspp.mry.hist  %>%
    mutate(test_year = factor(test_year)) %>%
    filter(grade == 13,
           subgroup_id %in% confetti.nmcusd.groups,
           test_id == 1, # ELA 
           entity_type == "District",
           str_detect(district_name, "North Monterey")
    ) %>%
        mutate(subgroup = if_else(subgroup == "English learners (ELs) enrolled in school in the U.S. fewer than 12 months", "English learners (ELs) enrolled in school \nin the U.S. fewer than 12 months", subgroup)) %>%
    three.years(collie = "subgroup",
                color_collie = subgroup,
                test.id = 1, 
                title.name =  "NMCUSD ")







### Grade Level -----


# Graphs assessment results by grade





graph.wrap.grade <- function(df, tit) {
    
    df %>% 
        select(starts_with("percent"), grade) %>%
        select(-percentage_standard_met_and_above) %>%
        mutate(grade = factor(grade)) %>%
        pivot_longer(starts_with("percent")) %>%
        mutate(name = str_sub(name, 21,-1),
               name = str_replace(name, "_"," "),
               name = str_to_title(name)
               ) %>%

        ggplot( aes( x = grade,  y = value, group = name, fill = name)) +
        geom_col(color = "black",
                 ) +
        # facet_wrap(vars(RealSubject),
        #            # vars(GradeLevelWhenAssessed),
        #            scales = "free") +
        geom_text(   # stat = "count",
                      aes(label = round(value,1)),
                      position = position_stack(vjust = 0.5), size = 3) +
         coord_flip() +
        theme_hc() +
        scale_fill_brewer() +
        guides(fill = guide_legend(reverse = TRUE)) + 
        labs(y = "Percentage at Each Achievement Level",
             x = "Grade Level",
             fill = "",
             title = paste0(tit, " CAASPP Math Achievement Level Percentage by Grade Level"))
    
    
    ggsave(here("figs", "grades", paste0(tit, " ", "Math",  " by Grade ",  Sys.Date(),".png" )),
           width = 12, height = 7)
    
}


caaspp.mry %>%
    filter(grade != 13,
           subgroup_id == "1",
           test_id == 2, # ELA 
           entity_type == "County",
           #          !is.na(percentage_standard_met_and_above)
    ) %>% 
    graph.wrap.grade("Monterey County")



caaspp.mry.hist %>%
    filter(test_year == 2023,
           grade != 13,
           subgroup_id == "1",
           test_id == 2, # ELA 
           entity_type == "County",
           #          !is.na(percentage_standard_met_and_above)
    ) %>% 
    graph.wrap.grade("Monterey County 2023")




graph.wrap.grade.fuller <- function(df, namer, ent.level) {
    
    
holder <-     df %>%
        filter(grade != 13,
               subgroup_id == "1",
               test_id == 2, # ELA 
               entity_type == ent.level,
               !is.na(percentage_standard_met_and_above))


if( ent.level == "School" ) {
    holder <- holder %>%
        filter(str_detect(school_name, namer))
} else {
    holder <- holder %>%
        filter(str_detect(district_name, namer))
}

        graph.wrap.grade(holder, namer)

}




graph.wrap.grade.fuller(caaspp.mry, "North Monterey County", "District")
graph.wrap.grade.fuller(caaspp.mry, "North Monterey County Middle", "School")
graph.wrap.grade.fuller(caaspp.mry, "North Monterey County High", "School")
graph.wrap.grade.fuller(caaspp.mry, "Salinas City", "District")
graph.wrap.grade.fuller(caaspp.mry, "Loma Vista", "School")
graph.wrap.grade.fuller(caaspp.mry, "Lincoln", "School")
graph.wrap.grade.fuller(caaspp.mry, "Boronda Meadows", "School")
graph.wrap.grade.fuller(caaspp.mry, "Soledad", "District")
graph.wrap.grade.fuller(caaspp.mry %>% filter(str_detect(district_name,"Soledad")), "Gabilan", "School")
graph.wrap.grade.fuller(caaspp.mry, "Soledad High", "School")
graph.wrap.grade.fuller(caaspp.mry, "Franscioni", "School")
graph.wrap.grade.fuller(caaspp.mry, "South Monterey County", "District")
graph.wrap.grade.fuller(caaspp.mry, "King City High", "School")
graph.wrap.grade.fuller(caaspp.mry, "Greenfield High", "School")
graph.wrap.grade.fuller(caaspp.mry, "Pinnacle Coastal Valley High", "School")
graph.wrap.grade.fuller(caaspp.mry, "Gonzales", "District")
graph.wrap.grade.fuller(caaspp.mry, "Fairview", "School")
graph.wrap.grade.fuller(caaspp.mry, "Gonzales High", "School")


